# Документация модуля DBViewerWidget (module2.py)

## Описание

Модуль DBViewerWidget (module2.py) предназначен для визуализации данных из таблиц базы данных SQLite в реальном времени. Модуль отображает числовые данные из таблиц `raw_data` и `external_data` в виде сетки индикаторов с возможностью переключения между таблицами.

## Основные возможности

1. **Отображение данных в реальном времени**
   - Автоматическое обновление данных с частотой 5 раз в секунду
   - Визуальная индикация изменений значений (красный цвет при изменении, затем синий)
   - Отображение времени последнего обновления

2. **Работа с разными таблицами**
   - Переключение между таблицами raw_data и external_data с помощью кнопок
   - Динамическое создание индикаторов в зависимости от структуры таблицы
   - Отображение всех числовых полей таблицы, кроме id

3. **Интеграция с основной программой**
   - Автоматическое получение соединения с БД через основное приложение
   - Корректная работа как в составе MonOilStudy, так и самостоятельно
   - Поддержка опции автообновления (можно включить/выключить)

## Исправленные проблемы

В последнем обновлении были исправлены следующие проблемы:

1. **Подключение к базе данных** - Модуль теперь проверяет несколько источников соединения с базой данных и автоматически выбирает рабочий вариант:
   - Через основное приложение (app.conn)
   - Через модуль 1 (app.module1.local_conn)
   - Напрямую к файлу new_database.db
   - Используя сохраненный путь к БД

2. **Обновление данных** - Улучшен алгоритм обновления данных:
   - Добавлена принудительная проверка соединения с БД перед каждым обновлением
   - Реализована система повторных попыток подключения при потере соединения
   - Добавлена дополнительная проверка на закрытые соединения SQLite

3. **Таймер обновления** - Переработана логика таймера обновления:
   - Теперь используется явный запуск таймера при инициализации
   - Интервал обновления можно настраивать через параметр update_interval
   - Добавлена защита от накопления таймеров при многократных вызовах

## Интерфейс

Интерфейс модуля состоит из следующих элементов:

1. **Верхняя панель**
   - Заголовок модуля
   - Кнопки переключения между таблицами raw_data и external_data
   - Индикатор состояния подключения к БД

2. **Сетка индикаторов**
   - Динамически генерируемая сетка в зависимости от полей таблицы
   - Каждый индикатор содержит название поля и его текущее значение
   - Адаптивное форматирование числовых значений

3. **Нижняя панель**
   - Отображение времени последнего обновления
   - Кнопка автообновления (A)
   - Кнопка принудительного обновления (⟳)

## Принцип работы

1. При инициализации модуль пытается найти соединение с БД через основное приложение или подключается к файлу new_database.db
2. Периодически проверяет обновления в БД с указанной частотой (5 раз в секунду)
3. При обнаружении обновлений получает последнюю запись из выбранной таблицы
4. Создает или обновляет сетку индикаторов в соответствии со структурой таблицы
5. Визуально выделяет изменившиеся значения и обновляет метку времени

## Интеграция с основной программой

Модуль интегрируется с основной программой MonOilStudy через класс Module2, который является наследником tk.Frame. Для подключения модуля к основной программе достаточно создать экземпляр класса Module2 и передать ему родительский виджет и ссылку на основное приложение:

```python
# В основной программе
self.module2 = Module2(parent_frame, app=self)
self.module2.pack(fill="both", expand=True)
```

## Дополнительные инструменты

Для тестирования и обеспечения корректной работы модуля созданы вспомогательные средства:

1. **test_module2.py** - Скрипт для тестирования модуля в автономном режиме
2. **test_integration.py** - Скрипт для тестирования интеграции модуля с основной программой:
   - Проверяет наличие и структуру базы данных
   - Создает необходимые таблицы и тестовые данные
   - Запускает процесс периодического обновления данных
   - Запускает основную программу MonOilStudy

## Требования

Для корректной работы модуля необходимо:

1. База данных SQLite с таблицами raw_data и/или external_data
2. Python 3.6 или выше
3. Tkinter (входит в стандартную библиотеку Python)

## Рекомендации по использованию

1. Перед запуском основной программы рекомендуется использовать скрипт test_integration.py для проверки и подготовки базы данных
2. Для ручного обновления данных используйте кнопку ⟳
3. Для включения/выключения автообновления используйте кнопку A
4. При необходимости можно изменить частоту обновления через параметр update_interval

## История изменений

### Версия 1.1 (текущая)
- Исправлены проблемы с подключением к БД в составе основной программы
- Улучшена система обновления данных и обработка ошибок соединения
- Добавлены инструменты тестирования и интеграции
- Оптимизирована логика работы таймера обновления

### Версия 1.0
- Полная переработка интерфейса модуля
- Реализация сетки индикаторов для отображения значений
- Добавление переключения между таблицами
- Визуальная индикация изменений значений
- Установка частоты обновления 5 раз в секунду 